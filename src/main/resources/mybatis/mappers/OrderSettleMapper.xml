<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.hrtx.web.mapper.OrderSettleMapper" >

    <select id="countConsumerSettle" resultType="java.util.HashMap">
        select sum(o.settle_amt) all_settle,
        sum(CASE WHEN o.fee_type=6 THEN od.sub_total	ELSE 0 END ) sale_price,
	    sum(CASE WHEN o.fee_type=6 THEN 1	ELSE 0 END) sale_count,
        sum(CASE WHEN o.status=1 THEN o.settle_amt	ELSE 0 END ) wait_settle,
        sum(CASE WHEN o.status=2 THEN o.settle_amt	ELSE 0 END) has_settle
        from tb_order_settle o left join tb_order od on od.order_id=o.order_id
        where o.`status` in (1,2) and o.fee_type in (1,6) and o.settle_user=#{consumer_id} and od.`status` not in (7)
    </select>

    <select id="settleUserMonthSignCount" resultType="java.util.HashMap">
        select os.id,os.status from tb_order_settle os left join tb_order o on os.order_id=o.order_id
        where o.`status`=6 and os.fee_type=#{fee_type} and date_format(os.add_date,'%Y%m')=#{settle_month} and os.settle_user=#{settle_user}
    </select>

    <select id="queryMonthSettle" resultType="java.util.HashMap">
        select os.settle_user,date_format(os.add_date,'%Y%m') settle_month,count(1) sign_count,group_concat(os.id) settle_ids
        from tb_order_settle os where os.fee_type=#{fee_type} and date_format(os.add_date,'%Y%m')=#{settle_month}
        group by os.settle_user,date_format(os.add_date,'%Y%m') having count(1)&lt;#{limit_count};
    </select>

</mapper>